#!/bin/sh /etc/rc.common

# ==============================================================================
# FILE: /etc/init.d/argon_daemon
# DESCRIPTION: Procd init script for Argon ONE V3 Fan Daemon
# AUTHOR: ciwga
# ==============================================================================

START=99
STOP=10
USE_PROCD=1
PROG=/usr/bin/argon_fan_control.sh

start_service() {
    config_load "argononev3"
    local enabled
    
    config_get_bool enabled "config" "enabled" 1
    if [ "$enabled" -eq 0 ]; then
        logger -t argon_init -p daemon.info "[INFO] Service disabled via UCI."
        return 0
    fi

    if [ ! -x "$PROG" ]; then
        logger -t argon_init -p daemon.err "[ERROR] $PROG not found."
        return 1
    fi

    # Clean stale lock from previous crash
    if [ -d "/var/run/argon_fan.lock" ]; then
        rm -f /var/run/argon_fan.lock/pid 2>/dev/null || true
        rmdir /var/run/argon_fan.lock 2>/dev/null || true
    fi

    procd_open_instance
    procd_set_param command "$PROG"
    procd_set_param respawn 3600 5 0
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}

service_triggers() {
    procd_add_reload_trigger "argon_daemon"
    procd_add_reload_trigger "argononev3"
}

reload_service() {
    restart
}

stop_service() {
    logger -t argon_init -p daemon.info "[INFO] Stopping Argon ONE Fan Service..."
    
    # Safety belt: Direct I2C fan-off in case daemon cleanup didn't fire
    local dev bus_num
    for dev in /dev/i2c-*; do
        [ -e "$dev" ] || continue
        bus_num="${dev##*-}"
        if i2cdetect -y -r "$bus_num" 2>/dev/null | grep -q "1a"; then
            i2cset -y -f "$bus_num" 0x1a 0x80 0x00 2>/dev/null || true
            break
        fi
    done
    
    rm -f /var/run/argon_fan.status /var/run/argon_fan.lock/pid 2>/dev/null || true
    rmdir /var/run/argon_fan.lock 2>/dev/null || true
}
