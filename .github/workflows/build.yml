# ==============================================================================
# FILE: .github/workflows/build.yml
# DESCRIPTION: OpenWrt IPK Automated Build & Release Pipeline for Argon ONE V3
# AUTHOR: ciwga
# ==============================================================================

name: Build OpenWrt IPK (RPi 5 - ArgonONE v3 Fan Control)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build OpenWrt IPK
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: source_code
          fetch-depth: 0
          token: ${{ github.token }}

      # Extract version using POSIX-safe grep+sed (no -oP dependency)
      - name: Extract Package Version from Makefile
        id: version
        run: |
          PKG_VER=$(sed -n 's/^PKG_VERSION:=//p' source_code/Makefile | tr -d '[:space:]')
          PKG_REL=$(sed -n 's/^PKG_RELEASE:=//p' source_code/Makefile | tr -d '[:space:]')
          echo "pkg_version=${PKG_VER}" >> "$GITHUB_OUTPUT"
          echo "pkg_release=${PKG_REL}" >> "$GITHUB_OUTPUT"
          echo "tag_name=v${PKG_VER}" >> "$GITHUB_OUTPUT"
          echo "full_version=${PKG_VER}-${PKG_REL}" >> "$GITHUB_OUTPUT"
          echo "Detected version: ${PKG_VER}-${PKG_REL}"

      - name: Check if Release Already Exists
        id: check_release
        run: |
          TAG="${{ steps.version.outputs.tag_name }}"
          # Use GitHub API directly - more reliable than git ls-remote
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release $TAG already exists. Build only."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release $TAG not found. Will create after build."
          fi

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget zstd

      - name: Download and Extract OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/24.10.5/targets/bcm27xx/bcm2712/openwrt-sdk-24.10.5-bcm27xx-bcm2712_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          wget -qO sdk.tar.zst "$SDK_URL"
          tar -I zstd -xf sdk.tar.zst
          mv openwrt-sdk-* openwrt_sdk

      - name: Air-Gapped Package Injection
        run: |
          sed -i 's/DEPENDS:=.*/DEPENDS:=@TARGET_bcm27xx_bcm2712/g' source_code/Makefile
          mkdir -p openwrt_sdk/package/luci-app-argononev3-fancontrol
          cp -r source_code/* openwrt_sdk/package/luci-app-argononev3-fancontrol/

      - name: Compile Package
        run: |
          cd openwrt_sdk
          rm -f .config
          touch .config
          echo "CONFIG_PACKAGE_luci-app-argononev3-fancontrol=m" >> .config
          make defconfig
          make package/luci-app-argononev3-fancontrol/compile V=s

      - name: Locate Built IPK
        id: find_ipk
        run: |
          IPK_PATH=$(find openwrt_sdk/bin/packages/ -name 'luci-app-argononev3-fancontrol_*.ipk' -type f | head -n 1)
          if [ -z "$IPK_PATH" ]; then
            echo "ERROR: No .ipk file found!"
            exit 1
          fi
          echo "ipk_path=$IPK_PATH" >> "$GITHUB_OUTPUT"
          echo "ipk_name=$(basename "$IPK_PATH")" >> "$GITHUB_OUTPUT"
          echo "Built: $(basename "$IPK_PATH")"

      - name: Generate Checksum
        id: checksum
        if: steps.check_release.outputs.exists == 'false'
        run: |
          SHA=$(sha256sum "${{ steps.find_ipk.outputs.ipk_path }}" | cut -d' ' -f1)
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"
          echo "SHA256: $SHA"

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argononev3-fancontrol-rpi5
          path: ${{ steps.find_ipk.outputs.ipk_path }}
          retention-days: 7

      - name: Create Git Tag
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cd source_code
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.version.outputs.tag_name }}" -m "Release ${{ steps.version.outputs.tag_name }}"
          git push origin "${{ steps.version.outputs.tag_name }}"

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: "Argon ONE V3 Fan Control ${{ steps.version.outputs.tag_name }}"
          body: |
            ## Argon ONE V3 Fan Control — ${{ steps.version.outputs.tag_name }}

            **Full version:** `${{ steps.version.outputs.full_version }}`
            **SHA256:** `${{ steps.checksum.outputs.sha256 }}`

            ### Quick Install (SSH)
            ```
            wget -qO - https://raw.githubusercontent.com/ciwga/luci-app-argononev3-fancontrol/main/install.sh | sh
            ```

            ### Upgrade
            Use **LuCI → Services → Argon ONE V3 Fan → About & Updates → Check for Updates**

            ### Build Info
            - **Commit:** `${{ github.sha }}`
            - **SDK:** OpenWrt 24.10.5 bcm27xx/bcm2712
            - **Arch:** aarch64_cortex-a76 (Raspberry Pi 5)
          files: ${{ steps.find_ipk.outputs.ipk_path }}
          draft: false
          prerelease: false