# ==============================================================================
# FILE: .github/workflows/build.yml
# DESCRIPTION: OpenWrt IPK Automated Build Pipeline for Argon ONE V3
# AUTHOR: ciwga
# ==============================================================================

name: Build OpenWrt IPK (RPi 5 - ArgonONE v3 Fan Control)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build OpenWrt IPK
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: source_code

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget zstd

      - name: Download and Extract OpenWrt SDK
        run: |
          SDK_URL="https://downloads.openwrt.org/releases/24.10.5/targets/bcm27xx/bcm2712/openwrt-sdk-24.10.5-bcm27xx-bcm2712_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          wget -qO sdk.tar.zst "$SDK_URL"
          tar -I zstd -xf sdk.tar.zst
          mv openwrt-sdk-* openwrt_sdk
      
      - name: Air-Gapped Package Injection
        run: |
          sed -i 's/DEPENDS:=.*/DEPENDS:=@TARGET_bcm27xx_bcm2712/g' source_code/Makefile
          
          mkdir -p openwrt_sdk/package/luci-app-argononev3-fancontrol
          cp -r source_code/* openwrt_sdk/package/luci-app-argononev3-fancontrol/

      - name: Compile Package
        run: |
          cd openwrt_sdk
          
          rm -f .config
          touch .config
          
          echo "CONFIG_PACKAGE_luci-app-argononev3-fancontrol=m" >> .config
          
          make defconfig
          
          make package/luci-app-argononev3-fancontrol/compile V=s

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argononev3-fancontrol-rpi5
          path: openwrt_sdk/bin/packages/*/base/luci-app-argononev3-fancontrol_*.ipk
          retention-days: 7